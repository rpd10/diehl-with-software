<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Scully 0.0.99">
  <meta charset="utf-8">
  <title>Angular Dynamic Environment Configuration | Diehl With Software</title>
  <base href="/diehl-with-software/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="styles.a0f8dbb50669c537439f.css"><style>.toolbar[_ngcontent-pqr-c21]{place-content:center;min-height:64px}.toolbar-content[_ngcontent-pqr-c21]{display:flex;flex-direction:row;align-items:center;max-width:960px;width:calc(100% - 32px)}.toolbar-content[_ngcontent-pqr-c21]   a[_ngcontent-pqr-c21], .toolbar-content[_ngcontent-pqr-c21]   a[_ngcontent-pqr-c21]:active, .toolbar-content[_ngcontent-pqr-c21]   a[_ngcontent-pqr-c21]:hover, .toolbar-content[_ngcontent-pqr-c21]   a[_ngcontent-pqr-c21]:link, .toolbar-content[_ngcontent-pqr-c21]   a[_ngcontent-pqr-c21]:visited{color:#fff;text-decoration:none}.content[_ngcontent-pqr-c21], .toolbar-content[_ngcontent-pqr-c21]   .spacer[_ngcontent-pqr-c21]{flex:1 0 auto}.footer[_ngcontent-pqr-c21]   .row[_ngcontent-pqr-c21]{height:32px;place-content:center}.footer[_ngcontent-pqr-c21]   .link[_ngcontent-pqr-c21]{height:32px;width:32px;line-height:32px}</style><style>.cdk-high-contrast-active .mat-toolbar{outline:solid 1px}.mat-toolbar-row,.mat-toolbar-single-row{display:flex;box-sizing:border-box;padding:0 16px;width:100%;flex-direction:row;align-items:center;white-space:nowrap}.mat-toolbar-multiple-rows{display:flex;box-sizing:border-box;flex-direction:column;width:100%}.mat-toolbar-multiple-rows{min-height:64px}.mat-toolbar-row,.mat-toolbar-single-row{height:64px}@media(max-width: 599px){.mat-toolbar-multiple-rows{min-height:56px}.mat-toolbar-row,.mat-toolbar-single-row{height:56px}}
</style><style>.mat-button .mat-button-focus-overlay,.mat-icon-button .mat-button-focus-overlay{opacity:0}.mat-button:hover .mat-button-focus-overlay,.mat-stroked-button:hover .mat-button-focus-overlay{opacity:.04}@media(hover: none){.mat-button:hover .mat-button-focus-overlay,.mat-stroked-button:hover .mat-button-focus-overlay{opacity:0}}.mat-button,.mat-icon-button,.mat-stroked-button,.mat-flat-button{box-sizing:border-box;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer;outline:none;border:none;-webkit-tap-highlight-color:transparent;display:inline-block;white-space:nowrap;text-decoration:none;vertical-align:baseline;text-align:center;margin:0;min-width:64px;line-height:36px;padding:0 16px;border-radius:4px;overflow:visible}.mat-button::-moz-focus-inner,.mat-icon-button::-moz-focus-inner,.mat-stroked-button::-moz-focus-inner,.mat-flat-button::-moz-focus-inner{border:0}.mat-button[disabled],.mat-icon-button[disabled],.mat-stroked-button[disabled],.mat-flat-button[disabled]{cursor:default}.mat-button.cdk-keyboard-focused .mat-button-focus-overlay,.mat-button.cdk-program-focused .mat-button-focus-overlay,.mat-icon-button.cdk-keyboard-focused .mat-button-focus-overlay,.mat-icon-button.cdk-program-focused .mat-button-focus-overlay,.mat-stroked-button.cdk-keyboard-focused .mat-button-focus-overlay,.mat-stroked-button.cdk-program-focused .mat-button-focus-overlay,.mat-flat-button.cdk-keyboard-focused .mat-button-focus-overlay,.mat-flat-button.cdk-program-focused .mat-button-focus-overlay{opacity:.12}.mat-button::-moz-focus-inner,.mat-icon-button::-moz-focus-inner,.mat-stroked-button::-moz-focus-inner,.mat-flat-button::-moz-focus-inner{border:0}.mat-raised-button{box-sizing:border-box;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer;outline:none;border:none;-webkit-tap-highlight-color:transparent;display:inline-block;white-space:nowrap;text-decoration:none;vertical-align:baseline;text-align:center;margin:0;min-width:64px;line-height:36px;padding:0 16px;border-radius:4px;overflow:visible;transform:translate3d(0, 0, 0);transition:background 400ms cubic-bezier(0.25, 0.8, 0.25, 1),box-shadow 280ms cubic-bezier(0.4, 0, 0.2, 1)}.mat-raised-button::-moz-focus-inner{border:0}.mat-raised-button[disabled]{cursor:default}.mat-raised-button.cdk-keyboard-focused .mat-button-focus-overlay,.mat-raised-button.cdk-program-focused .mat-button-focus-overlay{opacity:.12}.mat-raised-button::-moz-focus-inner{border:0}._mat-animation-noopable.mat-raised-button{transition:none;animation:none}.mat-stroked-button{border:1px solid currentColor;padding:0 15px;line-height:34px}.mat-stroked-button .mat-button-ripple.mat-ripple,.mat-stroked-button .mat-button-focus-overlay{top:-1px;left:-1px;right:-1px;bottom:-1px}.mat-fab{box-sizing:border-box;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer;outline:none;border:none;-webkit-tap-highlight-color:transparent;display:inline-block;white-space:nowrap;text-decoration:none;vertical-align:baseline;text-align:center;margin:0;min-width:64px;line-height:36px;padding:0 16px;border-radius:4px;overflow:visible;transform:translate3d(0, 0, 0);transition:background 400ms cubic-bezier(0.25, 0.8, 0.25, 1),box-shadow 280ms cubic-bezier(0.4, 0, 0.2, 1);min-width:0;border-radius:50%;width:56px;height:56px;padding:0;flex-shrink:0}.mat-fab::-moz-focus-inner{border:0}.mat-fab[disabled]{cursor:default}.mat-fab.cdk-keyboard-focused .mat-button-focus-overlay,.mat-fab.cdk-program-focused .mat-button-focus-overlay{opacity:.12}.mat-fab::-moz-focus-inner{border:0}._mat-animation-noopable.mat-fab{transition:none;animation:none}.mat-fab .mat-button-wrapper{padding:16px 0;display:inline-block;line-height:24px}.mat-mini-fab{box-sizing:border-box;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer;outline:none;border:none;-webkit-tap-highlight-color:transparent;display:inline-block;white-space:nowrap;text-decoration:none;vertical-align:baseline;text-align:center;margin:0;min-width:64px;line-height:36px;padding:0 16px;border-radius:4px;overflow:visible;transform:translate3d(0, 0, 0);transition:background 400ms cubic-bezier(0.25, 0.8, 0.25, 1),box-shadow 280ms cubic-bezier(0.4, 0, 0.2, 1);min-width:0;border-radius:50%;width:40px;height:40px;padding:0;flex-shrink:0}.mat-mini-fab::-moz-focus-inner{border:0}.mat-mini-fab[disabled]{cursor:default}.mat-mini-fab.cdk-keyboard-focused .mat-button-focus-overlay,.mat-mini-fab.cdk-program-focused .mat-button-focus-overlay{opacity:.12}.mat-mini-fab::-moz-focus-inner{border:0}._mat-animation-noopable.mat-mini-fab{transition:none;animation:none}.mat-mini-fab .mat-button-wrapper{padding:8px 0;display:inline-block;line-height:24px}.mat-icon-button{padding:0;min-width:0;width:40px;height:40px;flex-shrink:0;line-height:40px;border-radius:50%}.mat-icon-button i,.mat-icon-button .mat-icon{line-height:24px}.mat-button-ripple.mat-ripple,.mat-button-focus-overlay{top:0;left:0;right:0;bottom:0;position:absolute;pointer-events:none;border-radius:inherit}.mat-button-ripple.mat-ripple:not(:empty){transform:translateZ(0)}.mat-button-focus-overlay{opacity:0;transition:opacity 200ms cubic-bezier(0.35, 0, 0.25, 1),background-color 200ms cubic-bezier(0.35, 0, 0.25, 1)}._mat-animation-noopable .mat-button-focus-overlay{transition:none}.cdk-high-contrast-active .mat-button-focus-overlay{background-color:#fff}.cdk-high-contrast-black-on-white .mat-button-focus-overlay{background-color:#000}.mat-button-ripple-round{border-radius:50%;z-index:1}.mat-button .mat-button-wrapper>*,.mat-flat-button .mat-button-wrapper>*,.mat-stroked-button .mat-button-wrapper>*,.mat-raised-button .mat-button-wrapper>*,.mat-icon-button .mat-button-wrapper>*,.mat-fab .mat-button-wrapper>*,.mat-mini-fab .mat-button-wrapper>*{vertical-align:middle}.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-prefix .mat-icon-button,.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-suffix .mat-icon-button{display:block;font-size:inherit;width:2.5em;height:2.5em}.cdk-high-contrast-active .mat-button,.cdk-high-contrast-active .mat-flat-button,.cdk-high-contrast-active .mat-raised-button,.cdk-high-contrast-active .mat-icon-button,.cdk-high-contrast-active .mat-fab,.cdk-high-contrast-active .mat-mini-fab{outline:solid 1px}
</style><style>.mat-icon{background-repeat:no-repeat;display:inline-block;fill:currentColor;height:24px;width:24px}.mat-icon.mat-icon-inline{font-size:inherit;height:inherit;line-height:inherit;width:inherit}[dir=rtl] .mat-icon-rtl-mirror{transform:scale(-1, 1)}.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-prefix .mat-icon,.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-suffix .mat-icon{display:block}.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-prefix .mat-icon-button .mat-icon,.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-suffix .mat-icon-button .mat-icon{margin:auto}
</style><script charset="utf-8" src="common-es2015.9762d5e570429c84ac30.js"></script><script charset="utf-8" src="6-es2015.ded5634cccebb929eff8.js"></script><style>.blog-content-wrapper[_ngcontent-pqr-c22]{display:flex;flex-direction:column;box-sizing:border-box;align-items:center;padding:24px}.blog-content[_ngcontent-pqr-c22]{max-width:960px;width:100%}.blog-content[_ngcontent-pqr-c22]   .generated[_ngcontent-pqr-c22]   a[_ngcontent-pqr-c22], .blog-content[_ngcontent-pqr-c22]   .generated[_ngcontent-pqr-c22]   a[_ngcontent-pqr-c22]:active, .blog-content[_ngcontent-pqr-c22]   .generated[_ngcontent-pqr-c22]   a[_ngcontent-pqr-c22]:hover, .blog-content[_ngcontent-pqr-c22]   .generated[_ngcontent-pqr-c22]   a[_ngcontent-pqr-c22]:link, .blog-content[_ngcontent-pqr-c22]   .generated[_ngcontent-pqr-c22]   a[_ngcontent-pqr-c22]:visited{color:#1976d2}.blog-content[_ngcontent-pqr-c22]   .generated[_ngcontent-pqr-c22]   p[_ngcontent-pqr-c22], .blog-content[_ngcontent-pqr-c22]   .generated[_ngcontent-pqr-c22]   pre[_ngcontent-pqr-c22]{margin-bottom:20px}</style><style>
      :host {
        display: none;
      }
      scully-content {
        display: none;
      }
    </style><meta name="keywords" content="blog, Angular, Nx, angular dynamic environment, angular environment properties, angular environment runtime"><meta name="description" content="Improve upon Angular's default strategy for managing environment configuration by loading it dynamically at runtime, in a type-safe manner."><script>window['ScullyIO']='generated';</script>
<script type="text/javascript" id="scully-plugin-discount-flash-prevention">
  function capt (ev) {
	  if (document.documentElement.scrollTop === 0) {
	  	document.documentElement.scrollTop = window['ScullyIO-scrollPosition'];
	  }
	  window['ScullyIO-scrollPosition'] = document.documentElement.scrollTop;
	  function detach() {
		window.removeEventListener('scroll', capt);
		document.removeEventListener("AngularReady", detach);
	  };
	  document.addEventListener("AngularReady", detach);
	};

	window.addEventListener('scroll', capt);

	window.addEventListener('AngularReady', scullyDiscountFlashPreventionContentScript);
	function scullyDiscountFlashPreventionContentScript(){
	  document.documentElement.scrollTop = window['ScullyIO-scrollPosition'];
		document.body.classList.add('loaded');
		const tempAppRoot = document.querySelector('rpd10-root-scully');
    tempAppRoot.parentNode.removeChild(tempAppRoot);
    window.removeEventListener('AngularReady', scullyDiscountFlashPreventionContentScript);
    window.dispatchEvent(new Event('FlashPreventionSwitchDone', {
      bubbles: true,
      cancelable: false
    }))
	}
</script>
<style type="text/css">
	body:not(.loaded) rpd10-root { display:none; }
	body:not(.loaded) rpd10-root-scully { display:flex; }
	body.loaded rpd10-root { display:flex; }
  body.loaded rpd10-root-scully { display:none; }
</style>
</head>

<body class="mat-typography mat-app-background" scully-version="0.0.99">
  <rpd10-root></rpd10-root><rpd10-root-scully _nghost-pqr-c21="" ng-version="9.1.11"><mat-toolbar _ngcontent-pqr-c21="" color="primary" class="mat-toolbar toolbar mat-primary mat-toolbar-single-row"><div _ngcontent-pqr-c21="" class="toolbar-content"><a _ngcontent-pqr-c21="" href="/">Diehl With Software</a><span _ngcontent-pqr-c21="" class="spacer"></span></div></mat-toolbar><main _ngcontent-pqr-c21="" class="content"><router-outlet _ngcontent-pqr-c21=""></router-outlet><rpd10-blog _nghost-pqr-c22=""><div _ngcontent-pqr-c22="" class="blog-content-wrapper">
  <div _ngcontent-pqr-c22="" class="blog-content">
    <div _ngcontent-pqr-c22="" class="generated">
      <!--scullyContent-begin--><h1 id="angular-dynamic-environment-configuration" _ngcontent-pqr-c22="">Angular Dynamic Environment Configuration</h1>
<p _ngcontent-pqr-c22="">Out of the box, Angular provides a compile-time solution for managing environment-specific configuration. The default solution uses
file replacements at compile time - see the <a href="https://angular.io/guide/build#configuring-application-environments" _ngcontent-pqr-c22="" rel="noreferrer noopener">Angular Guide</a>.
This can work for many apps, but if you're working with a microservice-based backend using GitOps principles,
or doing continuous delivery with feature flags, you may want to be able to change configuration at runtime without rebuilding
the application.</p>
<p _ngcontent-pqr-c22="">Most of the solutions in this area resolve around the use of <code _ngcontent-pqr-c22="">APP_INITIALIZER</code> to delay loading the Angular application until
you can load the properties from a JSON file using a service over HTTP. At Penn State, we've been using that solution for
around 3 years (since Angular 2!), and it's worked well for us. I've also seen suggestions about using Angular Universal to inject the
configuration as environment variables on the server, and pass them to the client using TransferState, but that requires
adding SSR to your stack, which may be a big ask.</p>
<p _ngcontent-pqr-c22="">Recently I had the opportunity to take another look at our original implementation and freshen it up with some lessons learned over time.
Frankly, I was a little disappointed in myself when looking back at our old code - it lacked type safety, and seemed to be prone
to race conditions. In this space, I'll walk through an alternative implementation that does not use <code _ngcontent-pqr-c22="">APP_INITIALIZER</code>.</p>
<h2 id="the-setup" _ngcontent-pqr-c22="">The Setup</h2>
<p _ngcontent-pqr-c22="">I'll be using an <a href="https://nx.dev" _ngcontent-pqr-c22="" rel="noreferrer noopener">Nx Monorepo</a> and illustrating a workflow based on feature flags. We'll be loading configuration
at runtime and using <code _ngcontent-pqr-c22="">InjectionToken</code> to provide configuration to our apps and libs. The example repository is <a href="https://github.com/rpd10/example-angular-dynamic-environment" _ngcontent-pqr-c22="" rel="noreferrer noopener">here</a></p>
<p _ngcontent-pqr-c22="">To get things started, I'll generate a new empty Nx workspace:</p>
<pre _ngcontent-pqr-c22=""><code class="language-bash" _ngcontent-pqr-c22="">npx create-nx-workspace
? Workspace name (e.g., org name)     example-angular-dynamic-environment
? What to create in the new workspace empty
? CLI to power the Nx workspace       Angular CLI
? Use the free tier of the distributed cache provided by Nx Cloud? No</code></pre>
<p _ngcontent-pqr-c22="">Next, we'll use the Nx CLI to generate a new Angular application with routing. I highly recommend using <a href="https://nx.dev/angular/cli/console" _ngcontent-pqr-c22="" rel="noreferrer noopener">Nx Console</a>
to help with the CLI commands. Throughout the rest of this article, I'll show the raw CLI commands, but most likely I've copied/pasted
those commands from Nx Console.</p>
<pre _ngcontent-pqr-c22=""><code class="language-bash" _ngcontent-pqr-c22="">npm i -D @nrwl/angular
nx generate @nrwl/angular:application --name=demo --style=scss --routing --prefix=app</code></pre>
<p _ngcontent-pqr-c22="">Once Nx does it's thing, I'll remove the Nx branding from the generated application by removing the content from <code _ngcontent-pqr-c22="">app.component.scss</code>,
and <code _ngcontent-pqr-c22="">app.component.html</code>.
Next, I'll add Angular Material using the schematic, and generate a sidenav so we have some nice layout to work with in our application.</p>
<pre _ngcontent-pqr-c22=""><code class="language-bash" _ngcontent-pqr-c22="">nx add @angular/material
? Choose a prebuilt theme name, or "custom" for a custom theme: Indigo/Pink
? Set up global Angular Material typography styles? Yes
? Set up browser animations for Angular Material? Yes

nx generate @angular/material:navigation --name=layout --project=demo</code></pre>
<p _ngcontent-pqr-c22="">Finally, we'll modify the <code _ngcontent-pqr-c22="">app.component.html</code> to add <code _ngcontent-pqr-c22="">&lt;app-layout&gt;&lt;/app-layout&gt;</code>, and then modify <code _ngcontent-pqr-c22="">layout.component.html</code> to include the router outlet.
Look for the <code _ngcontent-pqr-c22="">&lt;!-- Add Content Here --&gt;</code> comment and replace it with <code _ngcontent-pqr-c22="">&lt;router-outlet&gt;&lt;/router-outlet&gt;</code>. If we start up the application at this point,
you should see a material sidenav with some dummy links.</p>
<h2 id="the-project" _ngcontent-pqr-c22="">The Project</h2>
<p _ngcontent-pqr-c22="">We've been tasked with building out the first few features of our application. We'll have a home/dashboard page with links out to our features,
and the first iteration will have 2 teams working concurrently to build out the first 2 features - Widgets and Customers. Our backend services
are going to be built and hosted elsewhere, and exposed over REST APIs. Our 2 project teams are going to race to see who can complete their feature
first, but each feature should be independently deployable - so if the Customers feature takes 1 sprint while Widgets takes 3, we want to be able
to deploy and turn on the Customers feature as soon as it's ready. We're going to have a staging and production environment, which will point
to different backends. Additionally, we do not want to have long-running feature branches - we want frequent integrations with the upstream branch,
so we need a way to disable a feature in the production environment, while having it turned on in staging so our stakeholders can check progress,
without rebuilding the application.</p>
<p _ngcontent-pqr-c22="">In this article, we'll focus on the Angular implementation. For our project, one key takeaway is that we need to build the application once,
host it in 2 places (staging and production), and change the configuration per hosting environment. So, we need to dynamically load the configuration
on bootstrap of the app, which means we cannot use the default environment.ts file. We'll need to make an HTTP request to a known endpoint to
load the configuration, and then provide that to the apps/libraries for consumption. Thankfully, Angular's dependency injection is
well suited to solve this problem.</p>
<h2 id="generate-a-config-library" _ngcontent-pqr-c22="">Generate a Config Library</h2>
<p _ngcontent-pqr-c22="">One thing we need to figure out is where should the application configuration be defined. In an Nx application, using a Library for this is an
obvious choice. This will allow both apps and libraries to import the configuration from a shared library. Depending on the complexity of your
application, you may even have multiple -config libraries, so you can take advantage of the <code _ngcontent-pqr-c22="">affected:</code> commands from Nx to only build what changed.
So let's go ahead and generate a configuration library, and while we're at it we'll generate the feature modules for home, widgets, and customers.</p>
<pre _ngcontent-pqr-c22=""><code class="language-bash" _ngcontent-pqr-c22="">nx generate @nrwl/angular:library --name=config --style=scss
nx generate @nrwl/angular:library --name=home --style=scss --lazy --routing
nx generate @nrwl/angular:library --name=customers --style=scss --lazy --routing
nx generate @nrwl/angular:library --name=widgets --style=scss --lazy --routing</code></pre>
<h2 id="define-the-app-configuration" _ngcontent-pqr-c22="">Define the App Configuration</h2>
<p _ngcontent-pqr-c22="">Next we'll need to define the shape of the application configuration. Since we're loading it dynamically, it would be nice to have an interface
describing what we expect the JSON to look like. We'll add this to the libs/config library, and make sure we export it from the library so it's
consumable from other areas. Here's our first cut:</p>
<pre _ngcontent-pqr-c22=""><code class="language-typescript" _ngcontent-pqr-c22="">// libs/config/src/lib/app.config.ts
import { InjectionToken } from '@angular/core';

export interface AppConfig {
  customers: CustomersConfig;
  widgets: WidgetsConfig;
}

export interface CustomersConfig {
  enabled: boolean;
  url: string;
}

export interface WidgetsConfig {
  enabled: boolean;
  url: string;
}

export const APP_CONFIG = new InjectionToken&lt;AppConfig&gt;('demo.app.config');

export const CUSTOMERS_CONFIG = new InjectionToken&lt;CustomersConfig&gt;(
  'demo.customers.config'
);

export const WIDGETS_CONFIG = new InjectionToken&lt;WidgetsConfig&gt;(
  'demo.widgets.config'
);</code></pre>
<p _ngcontent-pqr-c22="">Pretty simple - we've defined a high level configuration object that will be composed of smaller individual configurations. Next, we need to be able to
provide that configuration to injectable services. This is where <a href="https://angular.io/api/core/InjectionToken" _ngcontent-pqr-c22="" rel="noreferrer noopener">InjectionToken</a> comes in.
Now our customer library can inject the <code _ngcontent-pqr-c22="">CUSTOMERS_CONFIG</code> token and receive an object in the shape of <code _ngcontent-pqr-c22="">CustomerConfig</code>.
But we still need to provide those injection tokens. Let's do the simplest thing possible to get started - we can provide static, mock data by
defining providing the APP_CONFIG token in AppModule. We will then define factory functions for the customers and widgets tokens.</p>
<pre _ngcontent-pqr-c22=""><code class="language-typescript" _ngcontent-pqr-c22="">// app.module.ts
import { APP_CONFIG, AppConfig } from '@example-angular-dynamic-environment/config';

const appConfig: AppConfig = {
  customers: {
    enabled: true,
    url: 'http://fake-customers'
  },
  widgets: {
    enabled: true,
    url: 'http://fake-widgets'
  }
};

export function customersConfigFactory(config: AppConfig): CustomersConfig {
  return config.customers;
}

export function widgetsConfigFactory(config: AppConfig): WidgetsConfig {
  return config.widgets;
}

@NgModule({
  imports: [...],
  providers: [
    { provide: APP_CONFIG, useValue: appConfig },
    {
      provide: CUSTOMERS_CONFIG,
      useFactory: customersConfigFactory,
      deps: [APP_CONFIG],
    },
    {
      provide: WIDGETS_CONFIG,
      useFactory: widgetsConfigFactory,
      deps: [APP_CONFIG],
    },
  ],
})
export class AppModule {}</code></pre>
<h2 id="consuming-the-injection-tokens" _ngcontent-pqr-c22="">Consuming the Injection Tokens</h2>
<p _ngcontent-pqr-c22="">Let's see if we can now inject those <code _ngcontent-pqr-c22="">CUSTOMERS_CONFIG</code> and <code _ngcontent-pqr-c22="">WIDGETS_CONFIG</code> injection tokens into their respective feature libraries.
For both customers and widgets, we need to generate routed components, and then configure the application routing to use lazy-loading,
configure the child routing modules to display these routed components, and update the layout component to show the correct links.
In the interest of brevity, I will just list out the CLI commands I've run to get the boilerplate setup, the full setup is in the example repo.</p>
<pre _ngcontent-pqr-c22=""><code class="language-bash" _ngcontent-pqr-c22="">nx generate @schematics/angular:component --name=home --project=home --style=scss --changeDetection=OnPush --flat
nx generate @schematics/angular:component --name=customers --project=customers --style=scss --changeDetection=OnPush --flat
nx generate @schematics/angular:component --name=widgets --project=widgets --style=scss --changeDetection=OnPush --flat</code></pre>
<p _ngcontent-pqr-c22="">Let's update the Customers and Widgets components to inject their configuration, and just spit it out as JSON for now. We'll start with
Customers, the pattern will be the same for Widgets.</p>
<p _ngcontent-pqr-c22="">Here's the HTML:</p>
<pre _ngcontent-pqr-c22=""><code class="language-html" _ngcontent-pqr-c22="">&lt;h1&gt;Customers&lt;/h1&gt;
{{config | json}}</code></pre>
<p _ngcontent-pqr-c22="">And then the backing component:</p>
<pre _ngcontent-pqr-c22=""><code class="language-typescript" _ngcontent-pqr-c22="">// libs/customers/src/lib/customers.component.ts
import { ChangeDetectionStrategy, Component, Inject } from '@angular/core';
import {
  CustomersConfig,
  CUSTOMERS_CONFIG,
} from '@example-angular-dynamic-environment/config';

@Component({
  selector: 'example-angular-dynamic-environment-customers',
  templateUrl: './customers.component.html',
  styleUrls: ['./customers.component.scss'],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class CustomersComponent {
  constructor(@Inject(CUSTOMERS_CONFIG) public config: CustomersConfig) {}
}</code></pre>
<p _ngcontent-pqr-c22="">We're using Angular's <code _ngcontent-pqr-c22="">@Inject()</code> helper to grab the configuration and just spit it out as JSON. We can repeat the process for widgets,
run the application, and at this point we should be able to navigate to each page using the menu, and see our mock JSON spit out on the page.
The next step is going to be dynamically loading the actual configuration, instead of mocking it.</p>
<h2 id="loading-configuration-dynamically" _ngcontent-pqr-c22="">Loading Configuration Dynamically</h2>
<p _ngcontent-pqr-c22="">So at this point, we have all of the pieces in place to consume the injection tokens, we just need to figure out how to load the
configuration dynamically. Most existing patterns I've seen use <code _ngcontent-pqr-c22="">APP_INITIALIER</code> to call some Service that loads the config over HTTP.
In this example, we're going to leverage the <code _ngcontent-pqr-c22="">extraProviders</code> parameter for <code _ngcontent-pqr-c22="">platformBrowserDynamic</code> in conjuntion with <code _ngcontent-pqr-c22="">fetch</code>.</p>
<p _ngcontent-pqr-c22="">First, let's go back to our <code _ngcontent-pqr-c22="">AppModule</code> and remove the mock provider for <code _ngcontent-pqr-c22="">APP_CONFIG</code>, and the mock JSON configuration. Then, open
up <code _ngcontent-pqr-c22="">main.ts</code> and make a couple changes.</p>
<pre _ngcontent-pqr-c22=""><code class="language-typescript" _ngcontent-pqr-c22="">// main.ts

const configUrl = '???';

// NOTE: IE11 will require a polyfill for fetch
fetch(configUrl, { cache: 'no-cache' })
  .then((response): Promise&lt;AppConfig&gt; =&gt; response.json())
  .then((json) =&gt; {
    platformBrowserDynamic([{ provide: APP_CONFIG, useValue: json }])
      .bootstrapModule(AppModule)
      .catch((err) =&gt; console.error(err));
  });</code></pre>
<p _ngcontent-pqr-c22="">In a nutshell, we're going to wrap the call to bootstrap the Angular application with a fetch call to load the configuration.
<em _ngcontent-pqr-c22="">Note: IE 11 requires a polyfill for fetch support</em></p>
<p _ngcontent-pqr-c22="">After using fetch to request the configuration, we then provide the <code _ngcontent-pqr-c22="">APP_CONFIG</code> injection token as an argument to <code _ngcontent-pqr-c22="">platformBrowserDynamic</code>.
When the <code _ngcontent-pqr-c22="">AppModule</code> provider factory functions inject the <code _ngcontent-pqr-c22="">APP_CONFIG</code>, they will be provided with this value we loaded dynamically! Note that
I'm specifying <code _ngcontent-pqr-c22="">{ cache: no-cache }</code> as an option to fetch - this is important to allow your application to always get the most up-to-date config.</p>
<p _ngcontent-pqr-c22="">Just one thing left - at what URL should we query the configuration? This is going to vary based upon your deployment/ops setup,
and also will vary between local development and production. This is actually a great use case for the default Angular environment strategy.
Open up <code _ngcontent-pqr-c22="">environment.ts</code>. In the environment object, add a field for <code _ngcontent-pqr-c22="">configurationUrl</code>. Repeat for <code _ngcontent-pqr-c22="">environment.prod.ts</code>.</p>
<pre _ngcontent-pqr-c22=""><code class="language-typescript" _ngcontent-pqr-c22="">// environment.ts
export const environment = {
  production: false,
  configurationUrl: 'TODO',
};</code></pre>
<p _ngcontent-pqr-c22="">Next, go back to <code _ngcontent-pqr-c22="">main.ts</code> and update to fetch the url provided from the environment:</p>
<pre _ngcontent-pqr-c22=""><code class="language-typescript" _ngcontent-pqr-c22="">// main.ts
fetch(environment.configurationUrl, { cache: 'no-cache' });</code></pre>
<p _ngcontent-pqr-c22="">First, let's setup dev mode.</p>
<h2 id="loading-configuration-in-development-mode" _ngcontent-pqr-c22="">Loading Configuration in Development Mode</h2>
<p _ngcontent-pqr-c22="">When developing locally, we probably want the configuration to be hosted locally. The simplest way to do that is to place the configuration
in the <code _ngcontent-pqr-c22="">assets</code> folder of your application. Since Nx is running on top of the Angular CLI, anything we put into assets will be available
as a static asset at runtime. I'm going to group it under a config folder: <code _ngcontent-pqr-c22="">apps/demo/src/assets/config/my-app.json</code></p>
<pre _ngcontent-pqr-c22=""><code class="language-json" _ngcontent-pqr-c22="">// assets/config/my-app.json
{
  "customers": {
    "enabled": true,
    "url": "http://fake-customers"
  },
  "widgets": {
    "enabled": true,
    "url": "http://fake-widgets"
  }
}</code></pre>
<p _ngcontent-pqr-c22="">Now I can update <code _ngcontent-pqr-c22="">environment.ts</code> with the path to that file:</p>
<pre _ngcontent-pqr-c22=""><code class="language-typescript" _ngcontent-pqr-c22="">// environment.ts
export const environment = {
  production: false,
  configurationUrl: 'assets/config/my-app.json',
};</code></pre>
<p _ngcontent-pqr-c22="">Running <code _ngcontent-pqr-c22="">npm run start</code> at this point should yield a functional app again. You can try making a change to <code _ngcontent-pqr-c22="">my-app.json</code> - it should live reload
in the browser and your app should be updated. Nice! Next, we need to figure out how to deal with production builds.</p>
<h2 id="loading-configuration-in-production" _ngcontent-pqr-c22="">Loading Configuration in Production</h2>
<p _ngcontent-pqr-c22="">Disclaimer - this section is probably going to vary based on how you deploy your application, and how you are going to manage the configuration
in production. If you're deploying using Docker and Kubernetes, maybe your app is running on NGINX and you're hosting the configuration JSON
at some relative path. Or perhaps you've got a 3rd-party service-discovery service that hosts all your configuration JSON at a well-known URL.
Regardless, the one key is that you need to have a known URL that you can put into the <code _ngcontent-pqr-c22="">environment.prod.ts</code> file.</p>
<p _ngcontent-pqr-c22="">Let's say you've got some backend service that is hosting all of your configuration JSON. You'd simply update the prod file with the path
to that service:</p>
<pre _ngcontent-pqr-c22=""><code class="language-typescript" _ngcontent-pqr-c22="">// environment.prod.ts
export const environment = {
  production: true,
  configurationUrl: 'https://your-company-service-portal/my-app.json',
};</code></pre>
<p _ngcontent-pqr-c22="">One last thing - we probably don't want our local development version of <code _ngcontent-pqr-c22="">my-app.json</code> to be shipped out in the production build of the application.
Right now, if you run <code _ngcontent-pqr-c22="">nx build --prod</code> and then <code _ngcontent-pqr-c22="">cat dist/apps/demo/assets/config/my-app.json</code>, you'll see the config is being included.
We need to instruct the Angular CLI to exclude that file in production builds. We can do that by modifying the production build configuration.</p>
<p _ngcontent-pqr-c22="">Let's open up <code _ngcontent-pqr-c22="">angular.json</code>, find the <code _ngcontent-pqr-c22="">demo</code> project, and drill down to <code _ngcontent-pqr-c22="">architect-&gt;build</code>. Around line 24 we'll see the static assets, and
around line 32 you'll see the declaration for the production configuration. We're going to redefine how assets are included in production builds.</p>
<pre _ngcontent-pqr-c22=""><code class="language-json" _ngcontent-pqr-c22="">// angular.json
"configurations": {
  "production": {
    "fileReplacements": [{
      "replace": "apps/demo/src/environments/environment.ts",
      "with": "apps/demo/src/environments/environment.prod.ts"
    }],
    "assets": ["apps/demo/src/favicon.ico", {
      "glob": "**/*",
      "input": "apps/demo/src/assets/",
      "ignore": ["config/**"],
      "output": "/assets/"
    }]
  }</code></pre>
<p _ngcontent-pqr-c22="">Running <code _ngcontent-pqr-c22="">nx build --prod</code> again, and the <code _ngcontent-pqr-c22="">my-app.json</code> file should not appear in the dist folder. (Note: if you have no other files
under assets, the entire dist/apps/demo/assets directory will be excluded).</p>
<h2 id="summary" _ngcontent-pqr-c22="">Summary</h2>
<p _ngcontent-pqr-c22="">Hopefully this outlines an alternative way to load environment-specific configuration at runtime. I like this approach because it guarantees
the configuration is loaded before Angular even begins to bootstrap. We can then use the default provider factory functions and injection tokens
in order to work with these dynamic properties in a type-safe manner. The full example repository is up
on <a href="https://github.com/rpd10/example-angular-dynamic-environment" _ngcontent-pqr-c22="" rel="noreferrer noopener">GitHub</a>.</p>
<!--scullyContent-end--><script>try {window['scullyContent'] = {cssId:"_ngcontent-pqr-c22",html:document.body.innerHTML.split('<!--scullyContent-begin-->')[1].split('<!--scullyContent-end-->')[0]};} catch(e) {console.error('scully could not parse content');}</script><scully-content _ngcontent-pqr-c22=""></scully-content>
    </div>
    <a _ngcontent-pqr-c22="" rel="noopener noreferrer" target="_blank" mat-flat-button="" color="primary" aria-label="share this article on Twitter" class="mat-focus-indicator mat-flat-button mat-button-base mat-primary" href="https://twitter.com/intent/tweet?url=http://localhost:1864/blog/angular-dynamic-environment-configuration" tabindex="0" aria-disabled="false"><span class="mat-button-wrapper">
      <mat-icon _ngcontent-pqr-c22="" role="img" svgicon="twitter" class="mat-icon notranslate mat-icon-no-color" aria-hidden="true"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 400 400" style="enable-background:new 0 0 400 400;" xml:space="preserve" fit="" height="100%" width="100%" preserveAspectRatio="xMidYMid meet" focusable="false">
<style type="text/css">
	.st0{opacity:0.15;fill:#1976D2;}
	.st1{fill:#FFFFFF;}
 </style>
<g id="_x31_0_x2013_20_x25__Black_Tint">
	<rect class="st0" width="400" height="400"></rect>
</g>
<g id="Logo__x2014__FIXED">
	<g>
		<path class="st1" d="M153.6,301.6c94.3,0,145.9-78.2,145.9-145.9c0-2.2,0-4.4-0.1-6.6c10-7.2,18.7-16.3,25.6-26.6
			c-9.2,4.1-19.1,6.8-29.5,8.1c10.6-6.3,18.7-16.4,22.6-28.4c-9.9,5.9-20.9,10.1-32.6,12.4c-9.4-10-22.7-16.2-37.4-16.2
			c-28.3,0-51.3,23-51.3,51.3c0,4,0.5,7.9,1.3,11.7c-42.6-2.1-80.4-22.6-105.7-53.6c-4.4,7.6-6.9,16.4-6.9,25.8
			c0,17.8,9.1,33.5,22.8,42.7c-8.4-0.3-16.3-2.6-23.2-6.4c0,0.2,0,0.4,0,0.7c0,24.8,17.7,45.6,41.1,50.3c-4.3,1.2-8.8,1.8-13.5,1.8
			c-3.3,0-6.5-0.3-9.6-0.9c6.5,20.4,25.5,35.2,47.9,35.6c-17.6,13.8-39.7,22-63.7,22c-4.1,0-8.2-0.2-12.2-0.7
			C97.7,293.1,124.7,301.6,153.6,301.6"></path>
	</g>
</g>
</svg></mat-icon>
      Tweet
    </span><div matripple="" class="mat-ripple mat-button-ripple"></div><div class="mat-button-focus-overlay"></div></a>
  </div>
</div>
</rpd10-blog><!----></main><footer _ngcontent-pqr-c21=""><mat-toolbar _ngcontent-pqr-c21="" color="primary" class="mat-toolbar footer mat-primary mat-toolbar-multiple-rows"><mat-toolbar-row _ngcontent-pqr-c21="" class="mat-toolbar-row row"><span _ngcontent-pqr-c21="" class="mat-body-1">Find me on</span><a _ngcontent-pqr-c21="" mat-icon-button="" aria-label="find me on twitter" href="https://www.twitter.com/DiehlWithRyan" target="_blank" rel="noopener noreferrer" class="mat-focus-indicator link mat-icon-button mat-button-base" tabindex="0" aria-disabled="false"><span class="mat-button-wrapper"><mat-icon _ngcontent-pqr-c21="" role="img" svgicon="twitter" class="mat-icon notranslate mat-icon-no-color" aria-hidden="true"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 400 400" style="enable-background:new 0 0 400 400;" xml:space="preserve" fit="" height="100%" width="100%" preserveAspectRatio="xMidYMid meet" focusable="false">
<style type="text/css">
	.st0{opacity:0.15;fill:#1976D2;}
	.st1{fill:#FFFFFF;}
 </style>
<g id="_x31_0_x2013_20_x25__Black_Tint">
	<rect class="st0" width="400" height="400"></rect>
</g>
<g id="Logo__x2014__FIXED">
	<g>
		<path class="st1" d="M153.6,301.6c94.3,0,145.9-78.2,145.9-145.9c0-2.2,0-4.4-0.1-6.6c10-7.2,18.7-16.3,25.6-26.6
			c-9.2,4.1-19.1,6.8-29.5,8.1c10.6-6.3,18.7-16.4,22.6-28.4c-9.9,5.9-20.9,10.1-32.6,12.4c-9.4-10-22.7-16.2-37.4-16.2
			c-28.3,0-51.3,23-51.3,51.3c0,4,0.5,7.9,1.3,11.7c-42.6-2.1-80.4-22.6-105.7-53.6c-4.4,7.6-6.9,16.4-6.9,25.8
			c0,17.8,9.1,33.5,22.8,42.7c-8.4-0.3-16.3-2.6-23.2-6.4c0,0.2,0,0.4,0,0.7c0,24.8,17.7,45.6,41.1,50.3c-4.3,1.2-8.8,1.8-13.5,1.8
			c-3.3,0-6.5-0.3-9.6-0.9c6.5,20.4,25.5,35.2,47.9,35.6c-17.6,13.8-39.7,22-63.7,22c-4.1,0-8.2-0.2-12.2-0.7
			C97.7,293.1,124.7,301.6,153.6,301.6"></path>
	</g>
</g>
</svg></mat-icon></span><div matripple="" class="mat-ripple mat-button-ripple mat-button-ripple-round"></div><div class="mat-button-focus-overlay"></div></a></mat-toolbar-row><mat-toolbar-row _ngcontent-pqr-c21="" class="mat-toolbar-row row"><span _ngcontent-pqr-c21="" class="mat-caption">Copyright © 2020. All Rights Reserved.</span></mat-toolbar-row></mat-toolbar></footer></rpd10-root-scully>
<script id="ScullyIO-transfer-state"></script><script src="runtime-es2015.1f5ec3ee98e53e82bb93.js" type="module"></script><script src="runtime-es5.1f5ec3ee98e53e82bb93.js" nomodule="" defer=""></script><script src="polyfills-es5.39a5a0773d6939b0ac3c.js" nomodule="" defer=""></script><script src="polyfills-es2015.ab3ae01b5028dac3455c.js" type="module"></script><script src="main-es2015.2ee5cd753708fd8cbbdd.js" type="module"></script><script src="main-es5.2ee5cd753708fd8cbbdd.js" nomodule="" defer=""></script>


</body></html>